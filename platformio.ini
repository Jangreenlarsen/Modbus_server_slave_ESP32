# ============================================================================
# PlatformIO Configuration for ESP32-WROOM-32 Modbus RTU Server
# ============================================================================

[env:esp32]
platform = espressif32
board = esp32doit-devkit-v1
framework = arduino
monitor_speed = 115200
upload_speed = 460800
upload_before_reset = default_reset
upload_wait_for_upload_port = yes

# Auto-generate build info before each build
extra_scripts = pre:scripts/generate_build_info.py

# ============================================================================
# SERIAL PORT CONFIGURATION
# ============================================================================
# COM13 for ESP32 38-pin board
monitor_port = COM14
upload_port = COM14

# ============================================================================
# BUILD FLAGS
# ============================================================================
build_flags =
  -Os
  -Wall
  -Wextra
  -std=c99
  -DESP32
  -DCORE_DEBUG_LEVEL=CORE_DEBUG_LEVEL_INFO
  -DLOG_LOCAL_LEVEL=ESP_LOG_INFO
  # ArduinoJson size optimization (disable unused features)
  -DARDUINOJSON_ENABLE_NAN=0
  -DARDUINOJSON_ENABLE_INFINITY=0
  -DARDUINOJSON_ENABLE_COMMENTS=0
  -DARDUINOJSON_ENABLE_PROGMEM=0
  # W5500 Ethernet: Uncomment to enable (requires W5500 hardware on SPI bus)
  -DETHERNET_W5500_ENABLED

# ============================================================================
# LIBRARY DEPENDENCIES
# ============================================================================
# Using Arduino-ESP32 core with built-in ESP-IDF Wi-Fi/networking support
lib_deps =
  # Wi-Fi and networking (built-in to ESP-IDF)
  # No external dependencies needed - uses lwIP sockets and ESP-IDF WiFi API

  # ArduinoJson for HTTP REST API (v6.0.0+)
  bblanchon/ArduinoJson@^7.0.0

# ============================================================================
# NOTE: Project structure uses PlatformIO defaults:
#   - src/     (source files)
#   - include/ (header files)
#   - test/    (unit tests)
# ============================================================================

# ============================================================================
# MONITOR SETTINGS
# ============================================================================
# Auto-enter bootloader on upload
monitor_filters = esp32_exception_decoder
monitor_echo = no
monitor_eol = LF

# ============================================================================
# ADVANCED SETTINGS
# ============================================================================
# Custom partition table: app0=1.875MB at 0x10000 (standard), NVS=64KB, no OTA
# NOTE: Changing partition layout requires full flash erase: pio run -t erase
board_build.partitions = partitions.csv

# Flash settings
board_build.flash_size = 4MB
board_build.flash_freq = 80m
board_build.flash_mode = dio

# Embed TLS certificates for HTTPS (FEAT-016)
board_build.embed_txtfiles =
  certs/servercert.pem
  certs/prvtkey.pem

# Verbose output for debugging med de hw counter som er i spil, de tæller tilsyndeladene ikke præsigt
# build_type = debug
