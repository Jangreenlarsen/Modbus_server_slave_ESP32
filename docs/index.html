<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Modbus RTU Server - Dokumentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            padding: 20px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }

        .nav-buttons a {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
            font-weight: 500;
        }

        .nav-buttons a:hover {
            background: #764ba2;
        }

        .content {
            padding: 40px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: #f9f9f9;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .feature-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
        }

        .status-new {
            background: #fff3cd;
            color: #856404;
        }

        .status-working {
            background: #d1ecf1;
            color: #0c5460;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        table tr:hover {
            background: #f5f5f5;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        h2 {
            color: #667eea;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        h3 {
            color: #764ba2;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .section {
            margin: 30px 0;
        }

        .command-ref {
            background: #f0f0f0;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .example {
            background: #fffbf0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .example strong {
            color: #ff9800;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        footer {
            background: #f5f5f5;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }

        .toc {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }

        .toc h2 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            padding-left: 0;
        }

        .toc li {
            padding: 5px 0;
        }

        .toc a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s;
        }

        .toc a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .nav-buttons a {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß ESP32 Modbus RTU Server</h1>
            <p>Komplet Funktionsguide & Dokumentation</p>
            <p><small>Version 1.0.0 | Platform: ESP32-WROOM-32</small></p>
        </header>

        <div class="nav-buttons">
            <a href="#timere">Timere</a>
            <a href="#t√¶llere">T√¶llere</a>
            <a href="#cli-kommandoer">CLI Kommandoer</a>
            <a href="#gpio-features">GPIO Features</a>
            <a href="#registers-coils">Registers & Coils</a>
            <a href="#st-logic-programming">ST Logic</a>
            <a href="FEATURE_GUIDE.md" download>üì• Download Markdown</a>
        </div>

        <div class="content">
            <!-- TABLE OF CONTENTS -->
            <div class="toc">
                <h2>üìë Indholdsfortegnelse</h2>
                <ul>
                    <li><a href="#timere">1. Timere (4 modes)</a></li>
                    <li><a href="#t√¶llere">2. T√¶llere (3 modes)</a></li>
                    <li><a href="#cli-kommandoer">3. CLI Kommandoer (70+)</a></li>
                    <li><a href="#gpio-features">4. GPIO Features</a></li>
                    <li><a href="#registers-coils">5. Registers & Coils</a></li>
                    <li><a href="#st-logic-programming">6. ST Logic Programming (IEC 61131-3)</a></li>
                    <li><a href="#persistence">7. Persistence</a></li>
                    <li><a href="#eksempler">8. Praktiske Eksempler</a></li>
                </ul>
            </div>

            <!-- TIMERS SECTION -->
            <section class="section" id="timere">
                <h2>‚è±Ô∏è Timere</h2>
                <p>ESP32 serveren har <strong>4 uafh√¶ngige timere</strong> (Timer 1-4), hver med sit eget operationsmodus.</p>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>üîÑ Mode 1: One-shot</h3>
                        <p>3-fase sekvens</p>
                        <p><small>Afspil forudbestemt sekvens</small></p>
                        <span class="status-badge status-working">‚úÖ Virker</span>
                    </div>

                    <div class="feature-card">
                        <h3>üìç Mode 2: Monostable</h3>
                        <p>Retriggerable puls</p>
                        <p><small>Enkelt puls som kan genstartes</small></p>
                        <span class="status-badge status-working">‚úÖ Virker</span>
                    </div>

                    <div class="feature-card">
                        <h3>üí´ Mode 3: Astable</h3>
                        <p>Oscillator/Blinker</p>
                        <p><small>Kontinuerlig toggle</small></p>
                        <span class="status-badge status-pass">[PASS] Verificeret</span>
                    </div>

                    <div class="feature-card">
                        <h3>‚ö° Mode 4: Input-triggered</h3>
                        <p>Kantdetekterings-timer</p>
                        <p><small>Svar p√• input-kantudsving</small></p>
                        <span class="status-badge status-new">‚ú® Ny [PASS]</span>
                    </div>
                </div>

                <h3>Timer Mode 3: Astable Eksempel</h3>
                <p>1 Hz blink (1000ms ON, 1000ms OFF):</p>
                <pre><code>set timer 1 mode 3 on-ms:1000 off-ms:1000 \
  p1-output:1 p2-output:0 output-coil:200 enabled:1

# Verificering af oscillation:
read coil 200 1  # = 1 (HIGH)
# Vent 1 sekund
read coil 200 1  # = 0 (LOW)
# Vent 1 sekund
read coil 200 1  # = 1 (HIGH)</code></pre>

                <h3>üÜï Timer Mode 4: Input-triggered Eksempel</h3>
                <p>Responder p√• rising edge (0‚Üí1):</p>
                <pre><code>set timer 2 mode 4 input-dis:30 trigger-edge:1 \
  delay-ms:0 output-coil:250

# Test med COIL som input simulator:
write coil 30 value 0       # S√¶t input LOW
write coil 30 value 1       # 0‚Üí1 transition (TRIGGER!)
read coil 250 1             # Output = 1 (HIGH)

write coil 30 value 0       # 1‚Üí0 (ikke matching)
read coil 250 1             # Output stadig = 1

write coil 30 value 1       # 0‚Üí1 igen (TRIGGER!)
read coil 250 1             # Output = 1</code></pre>

                <table>
                    <thead>
                        <tr>
                            <th>Mode</th>
                            <th>Navn</th>
                            <th>Prim√¶r brug</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>One-shot</td>
                            <td>3-fase sekvens</td>
                            <td>‚úÖ Virker</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Monostable</td>
                            <td>Retriggerable puls</td>
                            <td>‚úÖ Virker</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Astable</td>
                            <td>Oscillator/Blink</td>
                            <td>‚úÖ [PASS]</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Input-triggered</td>
                            <td>Kantdetekterings</td>
                            <td>‚ú® Ny [PASS]</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- COUNTERS SECTION -->
            <section class="section" id="t√¶llere">
                <h2>üî¢ T√¶llere</h2>
                <p>ESP32 serveren har <strong>4 uafh√¶ngige t√¶llere</strong> (Counter 1-4), hver med valgfrit operationsmodus.</p>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>üìä Mode 1: SW</h3>
                        <p>Software Polling</p>
                        <p><small>~10 kHz maksfrekvens</small></p>
                        <span class="status-badge status-working">‚úÖ Virker</span>
                    </div>

                    <div class="feature-card">
                        <h3>‚ö° Mode 2: SW-ISR</h3>
                        <p>GPIO Interrupt</p>
                        <p><small>~100 kHz maksfrekvens</small></p>
                        <span class="status-badge status-working">‚úÖ Virker</span>
                    </div>

                    <div class="feature-card">
                        <h3>üöÄ Mode 3: HW (PCNT)</h3>
                        <p>Hardware Pulse Counter</p>
                        <p><small>>1 MHz maksfrekvens</small></p>
                        <span class="status-badge status-working">‚úÖ Virker</span>
                    </div>
                </div>

                <h3>Counter Features</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Supporteret</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Prescaler</strong></td>
                            <td>1, 4, 8, 16, 64, 256, 1024</td>
                            <td>‚úÖ Alle modes</td>
                        </tr>
                        <tr>
                            <td><strong>Scale Factor</strong></td>
                            <td>Float multiplikator</td>
                            <td>‚úÖ Alle modes</td>
                        </tr>
                        <tr>
                            <td><strong>Bit-Width</strong></td>
                            <td>8, 16, 32, 64 bit</td>
                            <td>‚úÖ Clamping</td>
                        </tr>
                        <tr>
                            <td><strong>Frequency</strong></td>
                            <td>0-20000 Hz</td>
                            <td>‚úÖ 1-sec window</td>
                        </tr>
                        <tr>
                            <td><strong>Direction</strong></td>
                            <td>Up / Down</td>
                            <td>‚úÖ Alle modes</td>
                        </tr>
                        <tr>
                            <td><strong>Control Register</strong></td>
                            <td>Start/Stop/Reset</td>
                            <td>‚úÖ Remote control</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Hardware Counter (Mode 3) Eksempel</h3>
                <pre><code># Konfigur√©r Counter 1 til PCNT p√• GPIO19
set counter 1 mode 3 hw-gpio:19 prescaler:1 \
  bit-width:32 scale:1.0

# Start t√¶ller
set counter 1 control auto-start:on

# Efter 10 sekunder med 1kHz signal (burde v√¶re ~10000):
read reg 10 5

# Register 10 = index (skaleret v√¶rdi)
# Register 11 = raw (fra prescaler)
# Register 12 = freq (Hz)
# Register 13 = ctrl (status)
# Register 14 = overflow</code></pre>
            </section>

            <!-- CLI COMMANDS SECTION -->
            <section class="section" id="cli-kommandoer">
                <h2>‚å®Ô∏è CLI Kommandoer (70+)</h2>
                <p>Serverens komplette kommandolinje-interface med 70+ kommandoer.</p>

                <h3>SHOW Kommandoer</h3>
                <div class="command-ref">
                    <code>show config</code> - Hele konfigurationen<br>
                    <code>show counters</code> - Counter-tabel<br>
                    <code>show timers</code> - Timer-status<br>
                    <code>show registers [s] [c]</code> - Holding-registers<br>
                    <code>show coils</code> - Coil-tilstande<br>
                    <code>show inputs</code> - Diskrete inputs<br>
                    <code>show version</code> - Firmware-info<br>
                    <code>show gpio</code> - GPIO-mappings<br>
                </div>

                <h3>TIMER Kommandoer</h3>
                <div class="command-ref">
                    <code>set timer 1 mode 1 [parameters]</code> - One-shot<br>
                    <code>set timer 1 mode 2 [parameters]</code> - Monostable<br>
                    <code>set timer 1 mode 3 [parameters]</code> - Astable<br>
                    <code>set timer 1 mode 4 [parameters]</code> - Input-triggered<br>
                </div>

                <h3>COUNTER Kommandoer</h3>
                <div class="command-ref">
                    <code>set counter 1 mode 1 [parameters]</code> - SW<br>
                    <code>set counter 1 mode 2 [parameters]</code> - SW-ISR<br>
                    <code>set counter 1 mode 3 [parameters]</code> - HW (PCNT)<br>
                    <code>set counter 1 control [bits]</code> - Control bits<br>
                </div>

                <h3>GPIO Kommandoer</h3>
                <div class="command-ref">
                    <code>set gpio 16 static map input:45</code> - GPIO ‚Üí Diskret input<br>
                    <code>set gpio 23 static map coil:112</code> - Coil ‚Üí GPIO<br>
                    <code>no set gpio 16</code> - Fjern kortl√¶gning<br>
                    <code>set gpio 2 enable</code> - Frigiv GPIO2 (disable heartbeat)<br>
                </div>

                <h3>PERSISTENCE Kommandoer</h3>
                <div class="command-ref">
                    <code>save</code> - Gem konfiguration til NVS<br>
                    <code>load</code> - Indl√¶s fra NVS<br>
                    <code>defaults</code> - Factory defaults<br>
                    <code>reboot</code> - Genstarte ESP32<br>
                </div>
            </section>

            <!-- GPIO SECTION -->
            <section class="section" id="gpio-features">
                <h2>üîå GPIO Features</h2>

                <h3>GPIO Zones</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Range</th>
                            <th>Brug</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Fysiske GPIO</strong></td>
                            <td>0-39</td>
                            <td>Direkte ESP32-pins</td>
                        </tr>
                        <tr>
                            <td><strong>Virtuelle GPIO</strong></td>
                            <td>100-255</td>
                            <td>L√¶ser/skriver COIL</td>
                        </tr>
                        <tr>
                            <td><strong>Reserverede</strong></td>
                            <td>0,2,4,5,15,19-21,33</td>
                            <td>System/Modbus</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üÜï Virtuelle GPIO Support</h3>
                <div class="example">
                    <strong>‚ú® Ny feature:</strong> Virtual GPIO (100-255) l√¶ser/skriver direkte til COIL-v√¶rdier<br>
                    <br>
                    <strong>Eksempel:</strong><br>
                    <code>Virtual GPIO 120</code> ‚Üí L√¶ser <code>COIL 20</code><br>
                    <code>Virtual GPIO 150</code> ‚Üí L√¶ser <code>COIL 50</code><br>
                    <br>
                    Perfekt til test uden fysiske GPIO-signaler!
                </div>

                <h3>GPIO2 Heartbeat</h3>
                <p>Built-in "system alive" indikator - blinker hver 500ms.</p>
                <pre><code># Enable heartbeat (standard):
set gpio 2 disable  # Reserve GPIO2 til heartbeat

# Disable heartbeat (frigiv GPIO2):
set gpio 2 enable   # GPIO2 til brugerkode</code></pre>
            </section>

            <!-- REGISTERS & COILS -->
            <section class="section" id="registers-coils">
                <h2>üíæ Registers & Coils (0-255) - NY LAYOUT v2.2.0+</h2>

                <h3>üÜï ST Logic Registers (200-251) - NHEDIN!</h3>
                <p>Register arrays er nu <strong>256 addresses (0-255)</strong> i stedet for 160. Registers 200-251 er dedikeret til ST Logic status og kontrol:</p>

                <p><strong>INPUT REGISTERS (Read-only Status):</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>Register</th>
                            <th>Form√•l</th>
                            <th>Detaljer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>200-203</strong></td>
                            <td>ST Logic Status (Logic1-4)</td>
                            <td>Bit 0=Enabled, Bit 1=Compiled, Bit 2=Running, Bit 3=Error</td>
                        </tr>
                        <tr>
                            <td><strong>204-207</strong></td>
                            <td>Execution Count</td>
                            <td>Antal exekveringer pr. program</td>
                        </tr>
                        <tr>
                            <td><strong>208-211</strong></td>
                            <td>Error Count</td>
                            <td>Antal fejl under eksekvering</td>
                        </tr>
                        <tr>
                            <td><strong>212-215</strong></td>
                            <td>Last Error Code</td>
                            <td>0=ok, 1=fejl</td>
                        </tr>
                        <tr>
                            <td><strong>216-219</strong></td>
                            <td>Variable Count</td>
                            <td>Antal bundne variable pr. program</td>
                        </tr>
                        <tr>
                            <td><strong>220-251</strong></td>
                            <td>Variable Output Values</td>
                            <td>Output v√¶rdier fra ST Logic programs</td>
                        </tr>
                    </tbody>
                </table>

                <p><strong>HOLDING REGISTERS (Read/Write Control):</strong></p>
                <table>
                    <thead>
                        <tr>
                            <th>Register</th>
                            <th>Form√•l</th>
                            <th>Detaljer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>200-203</strong></td>
                            <td>ST Logic Control (Logic1-4)</td>
                            <td>Bit 0=Enable, Bit 1=Start, Bit 2=Reset Error</td>
                        </tr>
                        <tr>
                            <td><strong>204-235</strong></td>
                            <td>Variable Input Values</td>
                            <td>Remote master kan skrive v√¶rdier til ST programmer</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üì° Remote Control Eksempel (SCADA/PLC)</h3>
                <pre><code># L√¶s status p√• Logic1
status = read_input_register(200)
if status & 0x0001:  # Bit 0
    print("Logic1 er aktiveret")

# L√¶s variable v√¶rdier
counter = read_input_register(220)  # Logic1 var[0]
led = read_input_register(221)      # Logic1 var[1]

# Kontroller Logic1 fra Modbus
write_single_register(200, 0x0001)  # Enable Logic1
write_single_register(204, 100)     # S√¶t input variabel til 100</code></pre>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #ddd;">

                <h3>Holding Registers (0-199)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Max</th>
                            <th>Brug</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>STATIC</strong></td>
                            <td>16</td>
                            <td>Faste v√¶rdier (persistent)</td>
                        </tr>
                        <tr>
                            <td><strong>DYNAMIC</strong></td>
                            <td>16</td>
                            <td>Auto-updated fra counter/timer</td>
                        </tr>
                        <tr>
                            <td><strong>Counter-bindet</strong></td>
                            <td>-</td>
                            <td>Index/Raw/Freq/Ctrl</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Coils (0-255)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Max</th>
                            <th>Brug</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>STATIC</strong></td>
                            <td>16</td>
                            <td>Faste ON/OFF (persistent)</td>
                        </tr>
                        <tr>
                            <td><strong>DYNAMIC</strong></td>
                            <td>16</td>
                            <td>Auto-updated fra counter/timer</td>
                        </tr>
                        <tr>
                            <td><strong>Timer-output</strong></td>
                            <td>-</td>
                            <td>Direct timer output</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- PERSISTENCE -->
            <section class="section" id="persistence">
                <h2>üíø Persistence (NVS)</h2>
                <p>Hele konfigurationen gemmes i <strong>Non-Volatile Storage</strong> med:</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>‚úÖ Schema versioning (v2 med migration)</li>
                    <li>‚úÖ CRC16 validation</li>
                    <li>‚úÖ Auto-save efter config</li>
                    <li>‚úÖ Reboot persistent</li>
                </ul>

                <h3>Persistence Eksempel</h3>
                <pre><code># Konfigur√©r timer
set timer 1 mode 3 on-ms:1000 off-ms:1000 output-coil:200 enabled:1

# Gem til NVS
save

# Verificer
show config

# Efter reboot - config auto-loader!
reboot</code></pre>
            </section>

            <!-- EXAMPLES -->
            <section class="section" id="eksempler">
                <h2>üìö Praktiske Eksempler</h2>

                <h3>Eksempel 1: 1 Hz Blink</h3>
                <div class="example">
                    <strong>Form√•l:</strong> Timer Mode 3 oscillator test
                </div>
                <pre><code>set timer 1 mode 3 on-ms:1000 off-ms:1000 \
  p1-output:1 p2-output:0 output-coil:200 enabled:1

read coil 200 1  # HIGH
# Vent 1.2 sekunder
read coil 200 1  # LOW
# Vent 1.2 sekunder
read coil 200 1  # HIGH igen</code></pre>

                <h3>üÜï Eksempel 2: Input-Triggered Alarm</h3>
                <div class="example">
                    <strong>Form√•l:</strong> Timer Mode 4 rising edge detection
                </div>
                <pre><code>set timer 2 mode 4 input-dis:30 trigger-edge:1 \
  delay-ms:0 output-coil:250

# Simul√©r input rising edge
write coil 30 value 1    # 0‚Üí1 TRIGGER!
read coil 250 1          # Output = 1

write coil 30 value 0    # 1‚Üí0 (ikke matching)
read coil 250 1          # Stadig 1

write coil 30 value 1    # 0‚Üí1 igen TRIGGER!
read coil 250 1          # Output = 1</code></pre>

                <h3>Eksempel 3: Hardware Counter</h3>
                <div class="example">
                    <strong>Form√•l:</strong> PCNT counter p√• GPIO19 (kr√¶ver 1kHz signal)
                </div>
                <pre><code>set counter 1 mode 3 hw-gpio:19 prescaler:1 \
  bit-width:32 scale:1.0

set counter 1 control auto-start:on

# Efter 10 sekunder:
read reg 10 5  # Register 10 = ~10000 (hvis 1kHz)</code></pre>

                <h3>Eksempel 4: GPIO Kortl√¶gning</h3>
                <div class="example">
                    <strong>Form√•l:</strong> Kortl√¶g GPIO til Modbus I/O
                </div>
                <pre><code># GPIO16 ‚Üí Diskret input 45
set gpio 16 static map input:45

# Coil 112 ‚Üí GPIO23 output
set gpio 23 static map coil:112

# Gem persistent
save

# GPIO16 HIGH ‚Üí Input 45 = 1
# Coil 112 = 1 ‚Üí GPIO23 HIGH</code></pre>
            </section>

            <!-- ST LOGIC PROGRAMMING SECTION -->
            <section class="section" id="st-logic-programming">
                <h2>üíæ ST Logic Programming</h2>
                <p>Program industrielle automationslogikker direkte p√• ESP32 ved hj√¶lp af <strong>IEC 61131-3 Structured Text (ST)</strong>.</p>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>üìù ST Programs</h3>
                        <p>4 uafh√¶ngige ST-programmer</p>
                        <p><small>Hver op til 5 KB kildekode</small></p>
                        <span class="status-badge status-pass">‚úÖ [PASS]</span>
                    </div>

                    <div class="feature-card">
                        <h3>‚öôÔ∏è Compilation</h3>
                        <p>Bytecode-compiler</p>
                        <p><small><100ms compilationstid</small></p>
                        <span class="status-badge status-pass">‚úÖ [PASS]</span>
                    </div>

                    <div class="feature-card">
                        <h3>üîó Variable Binding</h3>
                        <p>Binding til Modbus registers</p>
                        <p><small>INPUT/OUTPUT modes</small></p>
                        <span class="status-badge status-pass">‚úÖ [PASS]</span>
                    </div>

                    <div class="feature-card">
                        <h3>‚è±Ô∏è Execution</h3>
                        <p>10ms interval (100 Hz)</p>
                        <p><small>Non-blocking</small></p>
                        <span class="status-badge status-pass">‚úÖ [PASS]</span>
                    </div>
                </div>

                <h3>ST Sprog Features</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Supporteret</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Data Types</strong></td>
                            <td>INT, DWORD, BOOL, REAL</td>
                            <td>‚úÖ Alle typer</td>
                        </tr>
                        <tr>
                            <td><strong>Control Flow</strong></td>
                            <td>IF/ELSIF/ELSE, CASE, FOR, WHILE, REPEAT</td>
                            <td>‚úÖ Alle strukturer</td>
                        </tr>
                        <tr>
                            <td><strong>Operators</strong></td>
                            <td>Aritmetik, logisk, bitwise</td>
                            <td>‚úÖ Alle operatorer</td>
                        </tr>
                        <tr>
                            <td><strong>Built-in Functions</strong></td>
                            <td>ABS, MIN, MAX, SQRT, type conversions</td>
                            <td>‚úÖ 16 funktioner</td>
                        </tr>
                        <tr>
                            <td><strong>Variables</strong></td>
                            <td>Lokale + Modbus-bundne</td>
                            <td>‚úÖ Op til 32 pr. program</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üéØ Simpelt ST Program Eksempel</h3>
                <pre><code>VAR
  phase_counter: INT;
  blink_counter: INT;
  led: BOOL;
  blink_interval: INT;
END_VAR

phase_counter := phase_counter + 1;
IF phase_counter >= 1000 THEN
  phase_counter := 0;
END_IF;

IF phase_counter < 250 THEN
  blink_interval := 10;
ELSIF phase_counter < 500 THEN
  blink_interval := 25;
ELSIF phase_counter < 750 THEN
  blink_interval := 50;
ELSE
  blink_interval := 100;
END_IF;

IF blink_counter >= blink_interval THEN
  blink_counter := 0;
  led := NOT led;
ELSE
  blink_counter := blink_counter + 1;
END_IF;</code></pre>

                <h3>‚å®Ô∏è ST Logic CLI Kommandoer</h3>
                <div class="command-ref">
                    <code>set logic 1 upload "&lt;st_code&gt;"</code> - Upload ST program til Logic1<br>
                    <code>set logic 1 bind 2 100 output</code> - Bind variabel 2 til HR#100 (output)<br>
                    <code>set logic 1 enabled:true</code> - Aktiv√©r Logic1 program<br>
                    <code>set logic 1 delete</code> - Slet program<br>
                    <code>show logic 1</code> - Vis detaljer for Logic1<br>
                    <code>show logic all</code> - Vis alle 4 logic programmer<br>
                    <code>show logic stats</code> - Vis eksekverings-statistik<br>
                </div>

                <h3>üîÑ Unified Variable Mapping</h3>
                <p>ST variable bindings bruger samme <strong>unified mapping-system</strong> som GPIO pins. Dette betyder:</p>
                <ul style="margin-left: 20px;">
                    <li>‚úÖ Konsistent interface for alle variable-typer</li>
                    <li>‚úÖ Ingen kodeduplikering</li>
                    <li>‚úÖ Singlepoint for bindings-behandling</li>
                    <li>‚úÖ Nemt at tilf√∏je nye variable-kilder i fremtiden</li>
                </ul>

                <h3>üìä Arkitektur: 3-Fase Execution</h3>
                <pre><code>Loop iteration:
1. gpio_mapping_update()      ‚Üí L√¶s INPUT bindings (GPIO + ST)
2. st_logic_engine_loop()     ‚Üí Eksekv√©r alle enabled ST programmer
3. gpio_mapping_update()      ‚Üí Skriv OUTPUT bindings (GPIO + ST)</code></pre>

                <h3>‚úÖ Test Results</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Status</th>
                            <th>Detaljer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Program Upload & Compilation</td>
                            <td>‚úÖ [PASS]</td>
                            <td>8/8 tests passing</td>
                        </tr>
                        <tr>
                            <td>Variable Binding</td>
                            <td>‚úÖ [PASS]</td>
                            <td>INPUT/OUTPUT modes working</td>
                        </tr>
                        <tr>
                            <td>Execution Engine</td>
                            <td>‚úÖ [PASS]</td>
                            <td>17,441+ executions, 0 errors</td>
                        </tr>
                        <tr>
                            <td>LED Blink Demo</td>
                            <td>‚úÖ [PASS]</td>
                            <td>GPIO2 kontrolleret af ST program</td>
                        </tr>
                        <tr>
                            <td>Unified Mapping System</td>
                            <td>‚úÖ [PASS]</td>
                            <td>GPIO + ST variabler i samme system</td>
                        </tr>
                    </tbody>
                </table>

                <h3>üìö Dokumentation</h3>
                <ul style="margin-left: 20px;">
                    <li>üìù <a href="../ST_LOGIC_MODE_TEST_REPORT.md">ST Logic Mode Test Report</a></li>
                    <li>üìò <a href="../ST_LOGIC_MODE_FINAL_REPORT.md">Final Implementation Report</a></li>
                    <li>‚úÖ <a href="../ST_LOGIC_MODE_COMPLETE_REPORT.md">Complete Feature Report</a></li>
                    <li>üí° <a href="../LED_BLINK_DEMO.md">LED Blink Demonstration</a></li>
                    <li>üìñ <a href="../README_ST_LOGIC.md">Comprehensive ST Logic Guide</a></li>
                    <li>üöÄ <a href="ST_USAGE_GUIDE.md">ST Usage Guide</a></li>
                </ul>

                <h3>üìä ST Programming Status Summary</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Komponent</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Program Upload & Compilation</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>Bytecode compiler, <100ms compilation time</td>
                        </tr>
                        <tr>
                            <td><strong>ST Execution Engine</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>100 Hz cycle, 10ms intervals, non-blocking</td>
                        </tr>
                        <tr>
                            <td><strong>Variable Binding</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>INPUT/OUTPUT modes, unified mapping system</td>
                        </tr>
                        <tr>
                            <td><strong>Data Types</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>INT, DWORD, BOOL, REAL with type checking</td>
                        </tr>
                        <tr>
                            <td><strong>Control Flow</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>IF/ELSIF/ELSE, CASE, FOR, WHILE, REPEAT</td>
                        </tr>
                        <tr>
                            <td><strong>Built-in Functions</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>16 functions (ABS, MIN, MAX, SQRT, conversions)</td>
                        </tr>
                        <tr>
                            <td><strong>Error Diagnostics</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>Compilation errors, runtime errors, statistics</td>
                        </tr>
                        <tr>
                            <td><strong>GPIO Integration</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>GPIO2 LED demo, coil-based control</td>
                        </tr>
                        <tr>
                            <td><strong>Persistent Storage</strong></td>
                            <td>‚úÖ [COMPLETE]</td>
                            <td>Program + binding persistence via NVS</td>
                        </tr>
                        <tr>
                            <td><strong>Test Coverage</strong></td>
                            <td>‚úÖ [PASS]</td>
                            <td>18/18 comprehensive tests passing</td>
                        </tr>
                    </tbody>
                </table>

                <h3>‚ú® Latest Features (v2.2.0)</h3>
                <ul style="margin-left: 20px;">
                    <li>üÜï <strong>Modbus Registers 200-251:</strong> Dedicated ST Logic status & control registers</li>
                    <li>üÜï <strong>Remote Control via Modbus:</strong> Enable/disable programs and read status from SCADA/PLC</li>
                    <li>üÜï <strong>Register Array Expanded:</strong> 0-255 (from 160) - 52 new registers for ST Logic integration</li>
                    <li>üÜï <strong>GPIO Mapping Limit Increased:</strong> 32 mappings (from 8) - support for more simultaneous bindings</li>
                    <li>‚úÖ <strong>Multi-line Upload Mode:</strong> Easy copy-paste of ST programs from editors</li>
                    <li>‚úÖ <strong>Unified Variable Mapping:</strong> GPIO + ST variables in same system</li>
                    <li>‚úÖ <strong>Intuitive Bind Syntax:</strong> Variable-name based bindings (e.g., `set logic 1 bind counter reg:100`)</li>
                    <li>‚úÖ <strong>Program Overview:</strong> Status icons (üü¢ ACTIVE, üü° DISABLED, üî¥ FAILED, ‚ö™ EMPTY)</li>
                    <li>‚úÖ <strong>Error Diagnostics:</strong> Show compilation errors and runtime statistics</li>
                    <li>‚úÖ <strong>LED Demo:</strong> Interactive GPIO2 LED control demonstration</li>
                </ul>
            </section>

            <!-- CONSTRAINTS -->
            <section class="section">
                <h2>üìä Constraints & Limits</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Min</th>
                            <th>Max</th>
                            <th>Default</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Timers</td>
                            <td>1</td>
                            <td>4</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Counters</td>
                            <td>1</td>
                            <td>4</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td><strong>Holding Registers (v2.2.0+)</strong></td>
                            <td>0</td>
                            <td><strong>255</strong> (updated from 159)</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td><strong>Input Registers (v2.2.0+)</strong></td>
                            <td>0</td>
                            <td><strong>255</strong> (updated from 159)</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td><strong>ST Logic Registers</strong></td>
                            <td>200</td>
                            <td>251</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Coils</td>
                            <td>0</td>
                            <td>255</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td><strong>GPIO Mappings (v2.2.0+)</strong></td>
                            <td>1</td>
                            <td><strong>32</strong> (updated from 8)</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td><strong>ST Logic Programs</strong></td>
                            <td>1</td>
                            <td>4</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Prescaler</td>
                            <td>1</td>
                            <td>1024</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>Slave ID</td>
                            <td>0</td>
                            <td>247</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>Baudrate</td>
                            <td>300</td>
                            <td>115200</td>
                            <td>115200</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- TEST STATUS -->
            <section class="section">
                <h2>‚úÖ Test Status</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Status</th>
                            <th>Resultat</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Mode 4 Comprehensive</td>
                            <td>‚úÖ</td>
                            <td>Both rise/fall edge [PASS]</td>
                        </tr>
                        <tr>
                            <td>Mode 4 Simple</td>
                            <td>‚úÖ</td>
                            <td>Rising edge [PASS]</td>
                        </tr>
                        <tr>
                            <td>Mode 3 Timing</td>
                            <td>‚úÖ</td>
                            <td>1000ms ON/OFF [PASS]</td>
                        </tr>
                        <tr>
                            <td>Suite Extended</td>
                            <td>‚úÖ</td>
                            <td>10/11 PASS</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </div>

        <footer>
            <p><strong>ESP32 Modbus RTU Server v2.2.0</strong> | 2025-12-03</p>
            <p>üìñ <a href="FEATURE_GUIDE.md" style="color: #667eea;">L√¶s Markdown version</a> |
               üìò <a href="SETUP_GUIDE.md" style="color: #667eea;">Setup Guide</a> |
               üìù <a href="../CHANGELOG.md" style="color: #667eea;">Changelog</a></p>
            <p>GitHub: <a href="https://github.com/Jangreenlarsen/Modbus_server_slave_ESP32" style="color: #667eea;">Modbus_server_slave_ESP32</a></p>
        </footer>
    </div>
</body>
</html>
